# ClaimsBasedAuth
### ActiveDirectoryTest
Active directory example including:
* Validation of a User against the Domain
* Retrieval of specific user
* Retrieval and setting of Current User.  
* Query Domain Users 
* 
### Authentication Project
Claims Based Security .Net4.5.  The majority of the code is from 
[here](https://dotnetcodr.com/2013/02/14/introduction-to-claims-based-security-in-net4-5-with-c-part-2-the-new-inheritance-model/) 
tutorial.  The tutorial covers Claims, ClaimsIdentities, inhertance, Custom ClaimsAuthorizationManager
 and ClaimsPrincipalPermission Attribute, Custom ClaimsAuthenticationManager and much more.
### Mvc5Auth Project
Thee definitions below are from 
[here](https://software-security.sans.org/blog/2015/06/24/asp-net-mvc-using-identity-for-authentication-authorization)
and
[here](https://www.codeguru.com/csharp/.net/net_security/asp.net-mvc-and-claim-based-security.html)

**App_Start/Startup.Auth.cs** — Contains the authentication configuration setup during bootstrap of 
ASP.NET MVC application.

**App_Start/IdentityConfig.cs** — Configuring and extending ASP.NET Identity:

**ApplicationUserManager** - This class extends UserManager from ASP.NET Identity. 
Password construction rules, account lockout settings, and two-factor messages are configured here.

**Models/IdentityModels.cs** — This class defines the User Identity that is used in authentication and stored
to the database (ApplicationUser extends IdentityUser from ASP.NET Identity). The "default" database 
schema provided by ASP.NET Identity is limited of the box. It is generated by the EntityFramework with
CodeFirst approach during the first launch of the web application. More information on how the
ApplicationUser class can be extended with new fields can be found here.

**Controllers/AccountController.cs** — Finally, we get to the class that is actually using the configuration 
for performing registration and authentication. 


## IdentityServer

#### Server

Currently configureable to automatically authenticate users using Windows Authentication.  If Windows authentication fails the user is the prompted 
to login (active directory) or re-attempt automatic login via the "Windows Authentication" shown on the screen.  

##### Running for the First Time
* Clone this repo.
* Uncomment the InitializeDatabase() method call in Startup.Configure()
* Update the "IdentityServerDatabase" Connection String in the appsetting.json file
* Restore the database using the scripts/IdentityServer.bak
* Run Create... and Set... stored procedures (also found in the scripts directory)

You should now be able to browse to the discovery document and test the server login using the MVC_Client project. 
See **Users and UserStores** below for additional information on user configuration.  

##### Initial Setup Notes:

Full Tutorial can be found [here.](http://docs.identityserver.io/en/release/quickstarts/8_entity_framework.html)

Created from an Empty Core 2.1 Webapp

Install: IdentityServer4, IdentityServer4.EntityFramework, Microsoft.EntityFrameworkCore.Tools.DotNet,
Microsoft.Extensions.Configuration, and System.DirectoryServices.AccountManagement.

Logging install:  Serilog.AspNetCore, Serilog.Sinks.Console, and Serilog.Sinks.File 

Install Entity Framework Core Tools as explained [here.](https://docs.microsoft.com/en-us/ef/core/miscellaneous/cli/dotnet)

Run below to test Net Entity Framework tooling is istalled.  
```cmd
dotnet ef 
```

Copy in QuickstartIdentityServer directory's from [Quickstart 8](https://github.com/IdentityServer/IdentityServer4.Samples/tree/release/Quickstarts/8_EntityFrameworkStorage/src/QuickstartIdentityServer)
and set your connection string with userId and password.  

Run the migration Commands from the project directory
```cmd
dotnet ef migrations add InitialIdentityServerPersistedGrantDbMigration -c PersistedGrantDbContext -o Data/Migrations/IdentityServer/PersistedGrantDb
dotnet ef migrations add InitialIdentityServerConfigurationDbMigration -c ConfigurationDbContext -o Data/Migrations/IdentityServer/ConfigurationDb
```

At this point the Identity Server Database will be created when you run the project.  The sample data used to populate the database is pulled from the 
TestUsers.cs file.

Set up user tables and some sample data using the IdSrvUserTearDownSetUp.sql.

Migrate EF data model to project.  
```cmd
Scaffold-DbContext "Data Source=localhost;database=IdentityServer;trusted_connection=yes;" Microsoft.EntityFrameworkCore.SqlServer -OutputDir Models
```
***Caution**: by scaffolding the model the dbcontext class autmatically generates\d a connection string that was being used.
Instead the dbcontext should be injected and passed the connection string via appsettings.json  (see Startup.cs for example).*

##### Automatic Windows Authentication Configuration
To configure Automatic Windows Authentication set 'Autodetect' to 'true'
``` json
appsettings.json
"LoginConfiguration": {
    "Autodetect" :  "false"
```

##### Logging
The current configuration is set to log to console and write to log file.  You can configure logging in the Program.cs Main Method.  

##### Enabling CORS
CORS is enabled per Client Configuration or globaly by implementing ICorsPolicyService.  More information can be found [here.](http://docs.identityserver.io/en/release/topics/cors.html)

##### Users and UserStores
IUserStore.cs is used to search, validate, etc. users.  IUserStore is injected in the Startup.cs.  
The implementation ActiveDirectoryUserStore.cs uses Active Directory.  In order for of ActiveDirectoryUserStore.cs to 
build correctly the "User*" tables must be created in the IdentityServer Data base for this project.  
The Implementation of InMemoryUserStore.cs can be used with out the use of "User*" tables and is based on
static users.

*Note - IUserStore must be used in conjunction with correct implementation of IProfileService also
located in Startup.cs.  The Automatic Windows Authentication Configuration may not work with 
InMemoryUserStore*

##### Setting up Users and Client in the Database

Scripts to assist with data creation:
* [IdSrvClientSetUp.sql](scripts/IdSrvClientSetUp.sql)
* [IdSrvUserTearDownSetUp.sql](scripts/IdSrvUserTearDownSetUp.sql)

When inserting a *Secret* in the *ClientSecrets* table you can use the following code to create your
hash:
``` c#
using System;
using System.Security.Cryptography;
using System.Text;
					
public class Program
{
    public static void Main()
    {
        using (var sha = SHA256.Create())
        {
            var bytes = Encoding.UTF8.GetBytes("secret");
            var hash = sha.ComputeHash(bytes);
            string hashForDatabase = Convert.ToBase64String(hash);
		
	    Console.WriteLine(hashForDatabase);
	}
    }
}
```
 
### Samples

#### MVC_Client (Core)

Create Empty Core 2.1 Webapp

Install IdentityModel

Copy in MVCClient directories from [Quickstart 8](https://github.com/IdentityServer/IdentityServer4.Samples/tree/release/Quickstarts/8_EntityFrameworkStorage/src/MvcClient)
and Edit namespace of all files.  
  
How to configure authentication with Identity Server 4 can be seen in the Startup.cs.   


[ClaimsTroubleShooting 2.0](https://leastprivilege.com/2017/11/15/missing-claims-in-the-asp-net-core-2-openid-connect-handler/)
and [ClaimsTroubleShooting 2.1](https://leastprivilege.com/2018/06/14/improvements-in-claim-mapping-in-the-asp-net-core-2-1-openid-connect-handler/)
https://github.com/IdentityServer/IdentityServer4/issues/2213


#### MVCIdentityServer (Full Framework)

Create Empty Full FrameWork Webapp

Install IdentityModel

Set up MVCClient directories as in [Getting Started: MVC Authentication & Web APIs](https://identityserver.github.io/Documentation/docsv2/overview/mvcGettingStarted.html).  

**Notes:** 
  
How to configure authentication with Identity Server 4 can be seen in the Startup.cs.   
