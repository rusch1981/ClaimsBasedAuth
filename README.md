# ClaimsBasedAuth
The below examples are from the turorials listed below.  For detailed info refer to Microsoft 
Documentation 
[here](https://docs.microsoft.com/en-us/dotnet/framework/security/)
### Authentication Project
Claims Based Security .Net4.5.  The majority of the code is from 
[here](https://dotnetcodr.com/2013/02/14/introduction-to-claims-based-security-in-net4-5-with-c-part-2-the-new-inheritance-model/) 
tutorial.  The tutorial covers Claims, ClaimsIdentities, inhertance, Custom ClaimsAuthorizationManager
 and ClaimsPrincipalPermission Attribute, Custom ClaimsAuthenticationManager and much more.
### Mvc5Auth Project
Thee definitions below are from 
[here](https://software-security.sans.org/blog/2015/06/24/asp-net-mvc-using-identity-for-authentication-authorization)
and
[here](https://www.codeguru.com/csharp/.net/net_security/asp.net-mvc-and-claim-based-security.html)

**App_Start/Startup.Auth.cs** — Contains the authentication configuration setup during bootstrap of 
ASP.NET MVC application.

**App_Start/IdentityConfig.cs** — Configuring and extending ASP.NET Identity:

**ApplicationUserManager** - This class extends UserManager from ASP.NET Identity. 
Password construction rules, account lockout settings, and two-factor messages are configured here.

**Models/IdentityModels.cs** — This class defines the User Identity that is used in authentication and stored
to the database (ApplicationUser extends IdentityUser from ASP.NET Identity). The "default" database 
schema provided by ASP.NET Identity is limited of the box. It is generated by the EntityFramework with
CodeFirst approach during the first launch of the web application. More information on how the
ApplicationUser class can be extended with new fields can be found here.

**Controllers/AccountController.cs** — Finally, we get to the class that is actually using the configuration 
for performing registration and authentication. 


## IdentityServer

#### Server

Create Empty Core 2.1 Webapp

Install IdentityServer4, IdentityServer4.EntityFramework, Microsoft.EntityFrameworkCore.Tools.DotNet,
Microsoft.Extensions.Configuration, and System.DirectoryServices.AccountManagement.

Run below to test.  
```cmd
dotnet ef 
```

Copy in QuickstartIdentityServer directory's from [Quickstart 8](https://github.com/IdentityServer/IdentityServer4.Samples/tree/release/Quickstarts/8_EntityFrameworkStorage/src/QuickstartIdentityServer)

Run the migration Commands from the project directory
```cmd
dotnet ef migrations add InitialIdentityServerPersistedGrantDbMigration -c PersistedGrantDbContext -o Data/Migrations/IdentityServer/PersistedGrantDb
dotnet ef migrations add InitialIdentityServerConfigurationDbMigration -c ConfigurationDbContext -o Data/Migrations/IdentityServer/ConfigurationDb
```

Set up user tables and migrate EF data model to project.
```cmd
Scaffold-DbContext "Data Source=localhost;database=IdentityServer4;trusted_connection=yes;" Microsoft.EntityFrameworkCore.SqlServer -OutputDir Models
```

##### Users and UserStore
IUserStore.cs is used to search, validate, etc. users.  IUserStore is injected in the Startup.cs.  
The implementation ActiveDirectoryUserStore.cs uses Active Directory.  In order for of ActiveDirectoryUserStore.cs to 
build correctly the "User*" tables must be created in the IdentityServer Data base for this project.  
The Implementation of InMemoryUserStore.cs can be used with out the use of "User*" tables and is based on
static users.

*Note - IUserStore must be used in conjunction with correct implementation of IProfileService also
located in Startup.cs*

##### Setting up Users and Client in the Database

Scripts to assist with data creation:
* [IdSrvClientSetUp.sql](scripts/IdSrvClientSetUp.sql)
* [IdSrvUserTearDownSetUp.sql](scripts/IdSrvUserTearDownSetUp.sql)

When inserting a *Secret* in the *ClientSecrets* table you can use the following code to create your
hash:
``` c#
using System;
using System.Security.Cryptography;
using System.Text;
					
public class Program
{
    public static void Main()
    {
        using (var sha = SHA256.Create())
        {
            var bytes = Encoding.UTF8.GetBytes("secret");
            var hash = sha.ComputeHash(bytes);
            string hashForDatabase = Convert.ToBase64String(hash);
		
	    Console.WriteLine(hashForDatabase);
	}
    }
}
```
 
### ClientSamples

#### MVC_Client (Core)

Create Empty Core 2.1 Webapp

Install IdentityModel

Copy in MVCClient directories from [Quickstart 8](https://github.com/IdentityServer/IdentityServer4.Samples/tree/release/Quickstarts/8_EntityFrameworkStorage/src/MvcClient)
and Edit namespace of all files.  
  
How to configure authentication with Identity Server 4 can be seen in the Startup.cs.   



[ClaimsTroubleShooting 2.0](https://leastprivilege.com/2017/11/15/missing-claims-in-the-asp-net-core-2-openid-connect-handler/)
and [ClaimsTroubleShooting 2.1](https://leastprivilege.com/2018/06/14/improvements-in-claim-mapping-in-the-asp-net-core-2-1-openid-connect-handler/)
https://github.com/IdentityServer/IdentityServer4/issues/2213


#### MVCClient (Full Framework)

Create Empty Full FrameWork Webapp

Install IdentityModel

Set up MVCClient directories as in [Getting Started: MVC Authentication & Web APIs](https://identityserver.github.io/Documentation/docsv2/overview/mvcGettingStarted.html).  

**Notes:** 
  
How to configure authentication with Identity Server 4 can be seen in the Startup.cs.   